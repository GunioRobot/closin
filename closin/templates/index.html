<!doctype html>
<html>
	<head>
		<meta charset="UTF-8" />
		<title>DND zgz</title>
	</head>
	<body>
		<div id="categories">
			<img src="/cache/images-004/cabecera.png" style="background-color: black" />
			<ul>
				{% for cat in categories %}
				<li><a href="#" id="cat-{{ cat.key }}">{{ cat.name|escape }}</a></li>
				{% endfor %}
			</ul>
		</div>
		
		<div id="map-wrapper" style="display:none">
			<p><a href="#" id="back-home-button">&larr; Volver</a></p>
			<div id="map-container" style="width: 360px; height: 445px">
			</div>
		</div>
		
		<div id="detail" style="display:none">
			<p><a href="#" id="back-map-button">&larr; Volver</a></p>
			<p id="detail-title"></p>
			<ul id="detail-list">
			</ul>
		</div>
		
		<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
		<script src="/cache/jquery-1.3.2.min.js" type="application/x-javascript" charset="utf-8"></script>
		<script type="text/javascript" charset="utf-8">
			var map = null;
			var markers = [];
			
			function removeMarkers() {
				while(markers.length > 0) {
					markers.pop().setMap(null);
				}
			}
			
			function addMarker(lat, lon, title, subtitle, cat, id) {
				var marker = new google.maps.Marker({
					position: new google.maps.LatLng(lat, lon),
					map: map,
					title: title,
					icon: '/cache/images-004/icono.png'
				});
				if(id.length > 0) {
					google.maps.event.addListener(marker, 'click', function() {
						showDetail(id, cat, title, subtitle);
					});
				} else {
					google.maps.event.addListener(marker, 'click', function() {
						infowindow.content = title;
						infowindow.open(map, marker);
					});
				}
				markers.push(marker);
			}
			
			function showMap(cat) {
				$('#categories').hide();
				$('#map-wrapper').show();
				$('#detail').hide();
				
				if(!map) {
					initMap();
				}
				removeMarkers();
				
				$.ajax({ url: '/fetch?service='+cat,
					dataType: 'json',
					success: function(data) {
						var n = data.length;
						for(i=0; i<n; i++) {
							var place = data[i];
							var lat = place['lat'];
							var lon = place['lon'];
							var title = place['title'];
							var subtitle = place['subtitle'];
							var id = place['id'];
							addMarker(lat, lon, title, subtitle, cat, id);
						}
					}
				});
			}
			
			function showDetail(id, service, title, subtitle) {
				$("#detail-list").html("");
				$("#detail-title").html(title+"<br/>"+subtitle);
				$('#categories').hide();
				$('#map-wrapper').hide();
				$('#detail').show();
				
				$.ajax({ url: '/point?service='+service+'&id='+id,
					dataType: 'json',
					success: function(data) {
						var items = data["items"];
						var n = items.length;
						for(i=0; i<n; i++) {
							var lines = items[i];
							if(lines.length == 1) {
								$("#detail-list").append("<li>"+items[i][0]+"</li>");
							} else {
								$("#detail-list").append("<li>"+items[i][0]+"<br/>"+items[i][1]+"</li>");
							}
						}
					},
					error: function() {
						alert("Error en la conexi√≥n");
					}
				});
			}
			
			function backToMap() {
				$('#categories').hide();
				$('#detail').hide();
				$('#map-wrapper').show();
			}
			
			function showHome() {
				$('#categories').show();
				$('#map-wrapper').hide();
				$('#detail').hide();
			}
			
			function initMap() {
				var center = new google.maps.LatLng(41.641184, -0.894032);
				var zoom = 14;
				var myOptions = {
					zoom: zoom,
					center: center,
					navigationControl: false,
					disableDefaultUI: true,
					mapTypeId: google.maps.MapTypeId.ROADMAP
				};
				map = new google.maps.Map(document.getElementById("map-container"), myOptions);
			}
		
			$(document).ready(function() {
				showHome();
				$('#back-home-button').click(function(){showHome()});
				$('#back-map-button').click(function(){backToMap()});
				
				{% for cat in categories %}
				$('#cat-{{ cat.key }}').click(function() { showMap('{{ cat.key }}') });
				{% endfor %}
			});
		</script>
	</body>
</html>